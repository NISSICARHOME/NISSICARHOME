import React, { useRef, useEffect, useMemo } from 'react';
import { Product } from '../types';

// Base64 encoded swoosh sound - short and royalty-free
const scrollSound = 'data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU3LjgyLjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAB/8lAMASyVo+gBdj04iEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASxVo+gBdj04iEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASYVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASYVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAgxVpBAAAAADSAAAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAgAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASYVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASYVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAAAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAgAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASYVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASYVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAAAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAgxVpBAAAAADSAAAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAgxVpAAAAAADSAYAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASYVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASYVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAAAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAgAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASYVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASYVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAAAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAgxVpBAAAAADSAAAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAgxVpAAAAAADSAYAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASYVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASYVpBAAAAADSAAAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAAAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAgxVpAAAAAADSAYAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAgxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASYVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMASYVpBAAAAADSAAAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAAAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAgxVpAAAAAADSAYAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA/8lAMAQxVpBAAAAADSAEAD//3MA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFqCwBymQoA/+sA/yYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACY4AAA';

interface ProductCarouselProps {
    products: Product[];
    onProductSelect: (product: Product) => void;
}

const ProductCarousel: React.FC<ProductCarouselProps> = ({ products, onProductSelect }) => {
    const scrollContainerRef = useRef<HTMLDivElement>(null);
    const audioRef = useRef<HTMLAudioElement | null>(null);
    const intervalRef = useRef<ReturnType<typeof setInterval> | null>(null);
    const isJumping = useRef(false);

    const displayProducts = useMemo(() => {
        if (products.length === 0) return [];
        return [...products, ...products];
    }, [products]);

    useEffect(() => {
        audioRef.current = new Audio(scrollSound);
        audioRef.current.volume = 0.5;
    }, []);

    const playSound = () => {
        if (audioRef.current) {
            audioRef.current.currentTime = 0;
            audioRef.current.play().catch(error => console.log("Audio play failed:", error));
        }
    };

    const handleScrollButtonClick = (direction: 'left' | 'right') => {
        playSound();
        if (scrollContainerRef.current) {
            const scrollAmount = scrollContainerRef.current.clientWidth;
            scrollContainerRef.current.scrollBy({
                left: direction === 'left' ? -scrollAmount : scrollAmount,
                behavior: 'smooth',
            });
        }
    };
    
    const handleInfiniteScroll = () => {
        if (isJumping.current || !scrollContainerRef.current) return;
        const { scrollLeft, scrollWidth } = scrollContainerRef.current;
        const originalContentWidth = scrollWidth / 2;

        if (scrollLeft >= originalContentWidth) {
            isJumping.current = true;
            scrollContainerRef.current.scrollBy({ left: -originalContentWidth, behavior: 'instant' });
            setTimeout(() => { isJumping.current = false; }, 50);
        }
    };

    const startAutoScroll = () => {
        stopAutoScroll();
        intervalRef.current = setInterval(() => {
            if (scrollContainerRef.current) {
                scrollContainerRef.current.scrollBy({ left: scrollContainerRef.current.clientWidth, behavior: 'smooth' });
            }
        }, 3000);
    };

    const stopAutoScroll = () => {
        if (intervalRef.current) {
            clearInterval(intervalRef.current);
        }
    };

    useEffect(() => {
        startAutoScroll();
        const container = scrollContainerRef.current;
        container?.addEventListener('scroll', handleInfiniteScroll);

        return () => {
            stopAutoScroll();
            container?.removeEventListener('scroll', handleInfiniteScroll);
        };
    }, [products]);

    return (
        <div 
            className="relative w-full"
            onMouseEnter={stopAutoScroll}
            onMouseLeave={startAutoScroll}
        >
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="text-center mb-6">
                    <h3 className="text-2xl font-bold text-gray-800 sm:text-3xl">Explora Nuestra LÃ­nea</h3>
                </div>
            </div>
            <div className="relative flex items-center">
                <button
                    onClick={() => handleScrollButtonClick('left')}
                    className="absolute left-2 top-1/2 -translate-y-1/2 z-10 bg-white/50 backdrop-blur-sm border border-white/30 hover:bg-white/80 text-gray-800 rounded-full p-2 transition-all duration-300 shadow-md hidden md:flex items-center justify-center"
                    aria-label="Scroll Left"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
                </button>

                <div
                    ref={scrollContainerRef}
                    className="flex items-center gap-2 md:gap-4 overflow-x-auto scroll-smooth snap-x snap-mandatory scrollbar-hide py-36"
                >
                    {displayProducts.map((product, index) => (
                        <div key={`${product.name}-${index}`} className="snap-center flex-shrink-0 w-28 md:w-40 text-center flex flex-col items-center justify-start p-1 relative group hover:z-50">
                             <button 
                                onClick={() => onProductSelect(product)}
                                className="block w-24 h-24 md:w-36 md:h-36 transition-transform duration-300 ease-in-out group-hover:scale-[3] focus:outline-none focus:ring-2 focus:ring-amber-400 focus:ring-offset-4 focus:ring-offset-[#e0e5ec]"
                            >
                                <img
                                    src={product.image}
                                    alt={product.name}
                                    className="w-full h-full object-contain drop-shadow-lg"
                                    loading="lazy"
                                />
                            </button>
                            <span className="block text-xs md:text-sm font-semibold text-gray-800 mt-2 h-10 flex items-center justify-center text-center">{product.name}</span>
                        </div>
                    ))}
                </div>

                <button
                    onClick={() => handleScrollButtonClick('right')}
                    className="absolute right-2 top-1/2 -translate-y-1/2 z-10 bg-white/50 backdrop-blur-sm border border-white/30 hover:bg-white/80 text-gray-800 rounded-full p-2 transition-all duration-300 shadow-md hidden md:flex items-center justify-center"
                    aria-label="Scroll Right"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
        </div>
    );
};

export default ProductCarousel;